<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weekly Project Reporting</title>
  <!-- Supabase JavaScript library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background-color: #ffffff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      margin-top: 40px;
    }
    h1 {
      text-align: center;
    }
    .hidden {
      display: none;
    }
    .btn {
      padding: 8px 12px;
      margin: 4px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-danger {
      background-color: #f44336;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    table th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Hệ thống báo cáo tuần</h1>
    <div id="login-section">
      <p>Bạn cần đăng nhập bằng Google để sử dụng hệ thống.</p>
      <button class="btn" onclick="loginWithGoogle()">Đăng nhập bằng Google</button>
    </div>
    <div id="app" class="hidden">
      <p>Xin chào, <span id="user-email"></span>! (<span id="user-role"></span>) <button class="btn btn-danger" onclick="logout()">Đăng xuất</button></p>

      <!-- Form tạo báo cáo tuần -->
      <h2>Tạo báo cáo tuần mới</h2>
      <form id="report-form">
        <label for="week-start">Ngày bắt đầu tuần:</label>
        <input type="date" id="week-start" required />
        <label for="week-end">Ngày kết thúc tuần:</label>
        <input type="date" id="week-end" required />
        <h3>Mục công việc</h3>
        <table id="items-table">
          <thead>
            <tr>
              <th>Dự án</th>
              <th>Mô tả công việc</th>
              <th>Tỉ lệ hoàn thành (%)</th>
              <th>Ghi chú</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="items-body">
            <!-- Rows will be appended here -->
          </tbody>
        </table>
        <button class="btn" type="button" onclick="addItemRow()">Thêm dòng</button>
        <button class="btn" type="submit">Gửi báo cáo</button>
      </form>

      <!-- Danh sách báo cáo của tôi -->
      <h2>Báo cáo tuần của tôi</h2>
      <div id="my-reports"></div>
    </div>
  </div>

  <script>
    // Replace the following values with your Supabase project credentials
   
   const DATA_URL         = 'https://hziwyxbwqcdittvlhijo.supabase.co';
    const DATA_ANON_KEY    = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6aXd5eGJ3cWNkaXR0dmxoaWpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4ODE0MTksImV4cCI6MjA2OTQ1NzQxOX0.7kFGMEOX23Lg3b4imPalbju8G4yHyReuWBVoXVmvxEA';

 

   
    // Initialise Supabase client
    const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

    /**
     * Check authentication state when the page loads
     */
    document.addEventListener('DOMContentLoaded', async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        // Already logged in
        await loadUserAndData(user);
      }
    });

    /**
     * Log in via Google OAuth using Supabase Auth
     */
    async function loginWithGoogle() {
      // Redirect back to this page after sign‑in to preserve context
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: window.location.href
        }
      });
      if (error) {
        alert('Lỗi đăng nhập: ' + error.message);
      }
    }

    /**
     * Log out
     */
    async function logout() {
      await supabase.auth.signOut();
      document.getElementById('app').classList.add('hidden');
      document.getElementById('login-section').classList.remove('hidden');
    }

    /**
     * After login, load user data and initialize the app
     */
    async function loadUserAndData(user) {
      // Fetch user record from Users table to get role
      const { data: userData, error } = await supabase
        .from('Users')
        .select('id, email, role')
        .eq('id', user.id)
        .single();

      if (error) {
        alert('Không thể tải thông tin người dùng: ' + error.message);
        return;
      }
      // Show user info
      document.getElementById('user-email').textContent = userData.email;
      document.getElementById('user-role').textContent = userData.role;
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      // Load list of projects to populate dropdowns
      await loadProjects();
      // Show the user reports
      await loadMyReports();
    }

    /**
     * Load the list of projects from Supabase and store them globally
     */
    let projects = [];
    async function loadProjects() {
      const { data, error } = await supabase.from('Projects').select('id, name');
      if (error) {
        alert('Không thể tải danh sách dự án: ' + error.message);
        return;
      }
      projects = data;
      // Render initial row for items table
      addItemRow();
    }

    /**
     * Add a new row to the items table for another task
     */
    function addItemRow() {
      const tbody = document.getElementById('items-body');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <select class="project-select" required>
            <option value="">--Chọn dự án--</option>
            ${projects
              .map((p) => `<option value="${p.id}">${p.name}</option>`) 
              .join('')}
          </select>
        </td>
        <td><textarea class="task-desc" rows="2" placeholder="Mô tả công việc" required></textarea></td>
        <td><input type="number" class="completion-rate" min="0" max="100" value="0" required /></td>
        <td><input type="text" class="task-notes" placeholder="Ghi chú" /></td>
        <td><button type="button" class="btn btn-danger" onclick="removeRow(this)">Xóa</button></td>
      `;
      tbody.appendChild(row);
    }

    /**
     * Remove a row from the items table
     */
    function removeRow(btn) {
      const row = btn.closest('tr');
      row.remove();
    }

    /**
     * Submit the weekly report form
     */
    document.getElementById('report-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const weekStart = document.getElementById('week-start').value;
      const weekEnd = document.getElementById('week-end').value;
      if (!weekStart || !weekEnd) {
        alert('Vui lòng chọn ngày bắt đầu và kết thúc tuần.');
        return;
      }
      // Insert WeeklyReports record
      const { data: report, error: insertError } = await supabase
        .from('WeeklyReports')
        .insert({ week_start_date: weekStart, week_end_date: weekEnd })
        .select()
        .single();
      if (insertError) {
        alert('Không thể tạo báo cáo: ' + insertError.message);
        return;
      }
      // Prepare ReportItems
      const items = [];
      document.querySelectorAll('#items-body tr').forEach((tr) => {
        const projectId = tr.querySelector('.project-select').value;
        const taskDesc = tr.querySelector('.task-desc').value.trim();
        const completion = parseInt(tr.querySelector('.completion-rate').value, 10);
        const notes = tr.querySelector('.task-notes').value.trim();
        if (projectId && taskDesc) {
          items.push({
            report_id: report.id,
            project_id: projectId,
            task_description: taskDesc,
            completion_rate: completion,
            notes: notes || null,
          });
        }
      });
      if (items.length === 0) {
        alert('Vui lòng thêm ít nhất một dòng công việc.');
        return;
      }
      const { error: itemsError } = await supabase.from('ReportItems').insert(items);
      if (itemsError) {
        alert('Không thể lưu các mục công việc: ' + itemsError.message);
      } else {
        alert('Tạo báo cáo thành công!');
        // Reset form
        document.getElementById('report-form').reset();
        document.getElementById('items-body').innerHTML = '';
        addItemRow();
        loadMyReports();
      }
    });

    /**
     * Fetch and display the current user's weekly reports
     */
    async function loadMyReports() {
      // query weekly reports with nested report items and project names
      const { data, error } = await supabase
        .from('WeeklyReports')
        .select(
          `id, week_start_date, week_end_date, created_at,
           ReportItems(id, task_description, completion_rate, notes, project_id, Projects(name))`
        )
        .order('created_at', { ascending: false });
      if (error) {
        document.getElementById('my-reports').innerHTML = '<p>Lỗi: ' + error.message + '</p>';
        return;
      }
      if (!data || data.length === 0) {
        document.getElementById('my-reports').innerHTML = '<p>Chưa có báo cáo nào.</p>';
        return;
      }
      let html = '';
      data.forEach((report) => {
        html += `<div style="border: 1px solid #ddd; margin-bottom: 10px; padding: 10px;">
                    <h4>Báo cáo từ ${report.week_start_date} đến ${report.week_end_date}</h4>`;
        if (report.ReportItems && report.ReportItems.length > 0) {
          html += '<ul>';
          report.ReportItems.forEach((item) => {
            html += `<li>
                      <strong>${item.Projects ? item.Projects.name : ''}</strong>: ${item.task_description}
                      (Hoàn thành: ${item.completion_rate}%)
                      ${item.notes ? '- Ghi chú: ' + item.notes : ''}
                    </li>`;
          });
          html += '</ul>';
        } else {
          html += '<p>Không có mục công việc.</p>';
        }
        html += '</div>';
      });
      document.getElementById('my-reports').innerHTML = html;
    }

    // Listen for auth changes to handle redirect after login. When the user
    // completes OAuth flow, Supabase will automatically persist the session
    // and emit a SIGNED_IN event. We then load the user data.
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session && session.user) {
        loadUserAndData(session.user);
      } else if (event === 'SIGNED_OUT') {
        document.getElementById('app').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
