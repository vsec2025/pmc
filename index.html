<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CRM ‚Ä¢ Supabase ‚Ä¢ Bootstrap Admin (Dual‚ÄëProject Edition)</title>
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <!-- Supabase JS v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <!-- ‚úÇ¬†All CSS rules unchanged from previous file¬†‚úÇ -->
  <style>
    /* ‚Ä¶ existing styles ‚Ä¶ */
  </style>
</head>
<body>
  <!-- ‚úÇ¬†ALL MARK‚ÄëUP (sidebar, pages, forms‚Ä¶) REMAINS UNCHANGED¬†‚úÇ -->

  <!-- ========================= SCRIPTS ========================= -->
  <script>
    /* ============================================================
       0) SUPABASE CONFIG ‚Äì¬†**TWO PROJECTS**
       ------------------------------------------------------------
       CORE tables   : user_profiles, projects, customers  ‚Üí sbCore
       OTHER tables  : everything else                    ‚Üí sbData
       ------------------------------------------------------------ */
    const CORE_URL         = 'https://sdmjdhmkjyadgyfodpsf.supabase.co';
    const CORE_ANON_KEY    = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbWpkaG1ranlhZGd5Zm9kcHNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2ODQyNjIsImV4cCI6MjA2OTI2MDI2Mn0.Org3PD8CNmqCxC8ylbNiPA5Guo0w0srXgxyF2s2ZHG0';
    const DATA_URL         = 'https://hziwyxbwqcdittvlhijo.supabase.co';
    const DATA_ANON_KEY    = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6aXd5eGJ3cWNkaXR0dmxoaWpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4ODE0MTksImV4cCI6MjA2OTQ1NzQxOX0.7kFGMEOX23Lg3b4imPalbju8G4yHyReuWBVoXVmvxEA';

    const sbCore = supabase.createClient(CORE_URL, CORE_ANON_KEY);
    const sbData = supabase.createClient(DATA_URL, DATA_ANON_KEY);

    /* Proxy‚Äëstyle helper so legacy code can continue to call sb.from('table') */
    const CORE_TABLES = ['user_profiles','projects','customers'];
    const sb = {
      // route `.from()` to the correct project
      from: (tbl) => CORE_TABLES.includes(tbl) ? sbCore.from(tbl) : sbData.from(tbl),
      // Auth lives only in CORE project
      auth: sbCore.auth,
      // Expose storage if ever needed
      storage: sbData.storage
    };

    /* 1) GLOBAL STATE */
    let currentUser = { email: null, role: 'user' };
    let customers=[], projects=[], reports=[], /* ‚Ä¶the other arrays remain‚Ä¶ */ users=[];

    /* 2) GOOGLE¬†AUTH & WHITELIST (UNCHANGED) */
    // ‚úÇ¬†existing sign‚Äëin / sign‚Äëout logic that used `sb.auth` still works.

    /* 3) ROLE‚ÄëBASED UI HIDES Customers/Projects FOR NON‚ÄëADMINS */
    function applyRoleUI(){
      const isAdmin = ['admin'].includes(currentUser.role);
      // hide nav items
      document.querySelector('[data-page="customers"]').closest('li').style.display = isAdmin?'':'none';
      document.querySelector('[data-page="projects" ]').closest('li').style.display = isAdmin?'':'none';
    }

    /* 4) LOAD DATA (split clients automatically by sb.from) */
    async function loadAll(){
      const custRes = await sb.from('customers').select('*').order('id');
      const projRes = await sb.from('projects').select('*').order('project_id');
      const repRes  = await sb.from('weekly_reports').select('*');
      const usrRes  = await sb.from('user_profiles').select('*');
      customers = custRes.data||[];
      projects  = projRes.data ||[];
      reports   = repRes.data  ||[];
      users     = usrRes.data  ||[];
    }

    /* 5) NAVIGATION GUARD ‚Äì¬†block restricted pages even if user tweaks DOM */
    function showSection(page){
      const blocked = ['customers','projects'];
      if(blocked.includes(page) && !['admin'].includes(currentUser.role)){
        alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y');
        page = 'dashboard';
      }
      document.querySelectorAll('[id^="page-"]').forEach(s=>s.classList.add('d-none'));
      document.getElementById(`page-${page}`).classList.remove('d-none');
      document.querySelectorAll('.sidebar .nav-link').forEach(a=>a.classList.toggle('active',a.dataset.page===page));
    }

    /* 6) WEEKLY REPORT form ‚Äì¬†üîÑ user field removed (set = currentUser.email) */
    function openReportForm(id=''){
      const wrap=document.getElementById('reportFormWrap');
      const isEdit=!!id;
      const r=isEdit?reports.find(x=>x.report_id===id):{};
      wrap.classList.remove('d-none');
      window.scrollTo({top:0,behavior:'smooth'});
      const projectOptions = projects.map(p=>`<option value="${p.project_id}"${r?.project_id===p.project_id?' selected':''}>${p.project_name}</option>`).join('');
      wrap.innerHTML=`
        <div class="card card-shadow mb-4"><div class="card-body">
          <h5 class="card-title mb-3">${isEdit?'S·ª≠a':'Th√™m'} b√°o c√°o tu·∫ßn</h5>
          <div class="row g-3">
            <div class="col-md-3"><label class="form-label">ID</label><input class="form-control" disabled id="rep_id" value="${isEdit?r.report_id:generateReportId()}"></div>
            <div class="col-md-5"><label class="form-label">Project</label><select class="form-select" id="rep_project"><option value="">--ch·ªçn--</option>${projectOptions}</select></div>
            <div class="col-md-4"><label class="form-label">Date</label><input type="date" class="form-control" id="rep_date" value="${r?.date||''}"></div>
            <div class="col-md-2"><label class="form-label">Hours</label><input type="number" class="form-control" id="rep_hours" value="${r?.hours||''}"></div>
            <div class="col-12"><label class="form-label">C√¥ng vi·ªác</label><textarea class="form-control" rows="2" id="rep_task">${r?.task||''}</textarea></div>
          </div>
          <div class="mt-3 d-flex gap-2">
            <button class="btn btn-primary" onclick="${isEdit?`updateReport('${id}')`:'addReport()'}"><i class="bi bi-check2-circle me-1"></i>L∆∞u</button>
            <button class="btn btn-outline-secondary" onclick="document.getElementById('reportFormWrap').classList.add('d-none')">H·ªßy</button>
          </div>
        </div></div>`;
    }

    async function addReport(){
      const payload={
        report_id:document.getElementById('rep_id').value,
        user_email: currentUser.email,           // ‚¨Ö g·∫Øn t·ª± ƒë·ªông
        project_id: document.getElementById('rep_project').value,
        task      : document.getElementById('rep_task').value.trim(),
        hours     : parseFloat(document.getElementById('rep_hours').value||'0'),
        date      : document.getElementById('rep_date').value||null,
      };
      if(!payload.project_id) return alert('Ch∆∞a ch·ªçn d·ª± √°n h·ª£p l·ªá');
      if(!payload.date)       return alert('Ch∆∞a ch·ªçn ng√†y');
      payload.week = getWeekNumber(new Date(payload.date));
      const {error}=await sb.from('weekly_reports').insert([payload]);
      if(error) return alert(error.message);
      await loadAll(); renderReports(); renderSummary(); renderDashboard(); wrapReset();
    }
    async function updateReport(id){ /* same payload build as above */ /* ‚Ä¶ */ }

    /* 7) PROJECT‚ÄëLEVEL SUMMARY (TOTAL HOURS / D·ª∞ √ÅN) ‚Äì¬†replaces old per‚Äëuser summary */
    function renderSummary(){
      const tbody=document.getElementById('summaryTbody');
      const groups={};
      reports.forEach(r=>{
        const key=r.project_id||'';
        if(!groups[key]) groups[key]={project_id:key,hours:0,count:0};
        groups[key].hours+=parseFloat(r.hours||0);
        groups[key].count +=1;
      });
      tbody.innerHTML=Object.values(groups).map(g=>{
        const pr=projects.find(p=>p.project_id===g.project_id);
        return `<tr><td class="text-start">${pr?pr.project_name:g.project_id}</td><td>${g.hours}</td><td>${g.count}</td></tr>`;
      }).join('');
    }

    /* 8) INITIALISE AFTER LOGIN */
    async function initApp(){ await loadAll(); applyRoleUI(); renderDashboard(); }
    sb.auth.onAuthStateChange(async(ev,session)=>{
      if(session){ currentUser.email=session.user.email; const {data}=await sb.from('user_profiles').select('*').eq('email',currentUser.email).single(); currentUser.role=data?.role||'user'; await initApp(); } else { /* show sign-in overlay */ }
    });

    /* ============================================================
       *** All other logic (Customers, Projects, Quotes, Contracts, etc.)
           remains unchanged except that every sb.from(...) call now goes
           through the proxy and is routed to the correct project. ***
       ============================================================ */
  </script>
</body>
</html>
